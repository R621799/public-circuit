<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoe Generator - Final Integrated Build</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a2e; font-family: monospace; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        #ui {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px; border-radius: 8px;
            pointer-events: auto; /* Ensures buttons work */
            min-width: 250px;
        }
        button {
            width: 100%; padding: 10px; background: #e74c3c; color: white; border: none;
            cursor: pointer; font-size: 14px; font-weight: bold; margin-bottom: 10px;
        }
        button:active { background: #c0392b; }
        .stat { display: flex; justify-content: space-between; margin-top: 5px; color: #333; }
        .val { font-weight: bold; color: #2980b9; }
    </style>
</head>
<body>

    <div id="ui">
        <h3>âš¡ Generator Controls</h3>
        <button id="pedal-btn">PRESS FOOT PEDAL</button>
        <div class="stat"><span>Motor RPM:</span> <span id="rpm" class="val">0</span></div>
        <div class="stat"><span>Watts:</span> <span id="watts" class="val">0</span></div>
        <br>
        <small>Left Click: Rotate | Right Click: Pan</small>
    </div>

    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // --- CHECK IF LOADED ---
        if (typeof THREE === 'undefined') {
            alert("Error: Three.js did not load. Check your internet connection.");
        }

        // --- 1. SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x151515);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(6, 4, 6); // Good isometric angle

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // Lights
        const light = new THREE.DirectionalLight(0xffffff, 1.5);
        light.position.set(5, 8, 5);
        light.castShadow = true;
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));

        // --- 2. MATERIALS ---
        const matRack = new THREE.MeshStandardMaterial({ color: 0x95a5a6, roughness: 0.4 });
        const matGearA = new THREE.MeshStandardMaterial({ color: 0xe74c3c, metalness: 0.1 });
        const matGearB = new THREE.MeshStandardMaterial({ color: 0x3498db, metalness: 0.1 });
        const matMotor = new THREE.MeshStandardMaterial({ color: 0x34495e, metalness: 0.6 });

        // --- 3. BUILD THE MACHINE ---

        // GROUP A: The Rack (Up/Down)
        const rackGroup = new THREE.Group();
        // The main bar
        const rackBar = new THREE.Mesh(new THREE.BoxGeometry(0.4, 4, 0.4), matRack);
        rackGroup.add(rackBar);
        // The Teeth
        for(let i=0; i<15; i++){
            const tooth = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.1, 0.5), matRack);
            tooth.position.set(0.2, -1.5 + (i * 0.25), 0); 
            rackGroup.add(tooth);
        }
        rackGroup.position.set(-1.2, 2, 0);
        scene.add(rackGroup);

        // GROUP B: The Pinion (Red Gear)
        const pinion = new THREE.Group();
        // Core
        pinion.add(new THREE.Mesh(new THREE.CylinderGeometry(0.7, 0.7, 0.3, 32), matGearA));
        // Teeth
        for(let i=0; i<12; i++){
            const angle = (i/12) * Math.PI * 2;
            const tooth = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.3, 0.15), matGearA);
            tooth.position.set(Math.cos(angle)*0.7, 0, Math.sin(angle)*0.7);
            tooth.rotation.y = angle;
            pinion.add(tooth);
        }
        pinion.rotation.z = Math.PI/2; 
        pinion.position.set(-0.4, 1, 0);
        scene.add(pinion);

        // GROUP C: The Motor Shaft Gear (Blue)
        const motorGear = new THREE.Group();
        motorGear.add(new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.35, 0.3, 32), matGearB));
        for(let i=0; i<8; i++){
            const angle = (i/8) * Math.PI * 2;
            const tooth = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.3, 0.1), matGearB);
            tooth.position.set(Math.cos(angle)*0.35, 0, Math.sin(angle)*0.35);
            tooth.rotation.y = angle;
            motorGear.add(tooth);
        }
        motorGear.rotation.z = Math.PI/2;
        motorGear.position.set(0.65, 1, 0); // Meshed with Red Gear
        scene.add(motorGear);

        // GROUP D: The Motor (Horizontal Rotation)
        const motor = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.5, 32), matMotor);
        motor.rotation.z = Math.PI/2;
        motor.position.set(1.8, 1, 0);
        scene.add(motor);

        // Floor (Reference)
        const floor = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
        scene.add(floor);

        // --- 4. LOGIC ---
        const state = { y: 2, targetY: 2 };
        const btn = document.getElementById('pedal-btn');
        
        // Interaction
        btn.onmousedown = () => state.targetY = 0; // Push down
        btn.onmouseup = () => state.targetY = 2;   // Spring back
        // Also support touch for mobile
        btn.ontouchstart = (e) => { e.preventDefault(); state.targetY = 0; };
        btn.ontouchend = (e) => { e.preventDefault(); state.targetY = 2; };

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);

            // 1. Move Rack
            const lastY = state.y;
            state.y += (state.targetY - state.y) * 0.1; // Smooth ease
            rackGroup.position.y = state.y;

            // 2. Calculate Gear Rotation
            const delta = lastY - state.y; // How much we moved
            
            // Rack moves linear -> Pinion rotates angular
            // Arc = radius * angle -> angle = arc / radius
            const rotA = delta / 0.7; 
            pinion.rotation.y += rotA;

            // 3. Gear Ratio
            // Red Gear (0.7 radius) drives Blue Gear (0.35 radius)
            // Ratio = 2:1. Blue spins 2x faster, opposite direction.
            const rotB = -(rotA * 2);
            motorGear.rotation.y += rotB;
            
            // 4. Motor spins with Blue Gear
            motor.rotation.x = motorGear.rotation.y;

            // 5. UI Updates
            const rpm = Math.abs(delta) * 1000;
            document.getElementById('rpm').innerText = Math.round(rpm);
            document.getElementById('watts').innerText = Math.round(rpm * 0.15);

            controls.update();
            renderer.render(scene, camera);
        }

        // Resize Fix
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

        animate();
    </script>
</body>
</html>