<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoe Generator - Precise Gear Mechanics</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a2e; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* UI Overlay */
        #ui-layer {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 12px;
            width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 { margin: 0 0 15px 0; font-size: 1.2rem; color: #333; border-bottom: 2px solid #444; padding-bottom: 10px; }
        button {
            width: 100%; padding: 15px; border: none; background: #2980b9; color: white;
            font-size: 1rem; font-weight: bold; border-radius: 6px; cursor: pointer;
            transition: background 0.2s;
        }
        button:active { background: #1f6391; transform: scale(0.98); }
        .stats { margin-top: 15px; font-size: 0.9rem; color: #555; }
        .stat-row { display: flex; justify-content: space-between; margin: 5px 0; }
        .val { font-weight: bold; color: #2980b9; }
    </style>
</head>
<body>
    <div id="ui-layer">
        <h1>⚙️ Rack & Pinion Gen</h1>
        <button id="pedal-btn">PRESS PEDAL</button>
        <div class="stats">
            <div class="stat-row"><span>Motor Speed:</span> <span class="val" id="rpm">0 RPM</span></div>
            <div class="stat-row"><span>Energy Gen:</span> <span class="val" id="energy">0 W</span></div>
        </div>
    </div>
    <div id="canvas-container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(8, 6, 8);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 1, 0);

        // Lighting
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        scene.add(dirLight);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        // --- 2. ENGINEERING MATERIALS ---
        const matSteel = new THREE.MeshStandardMaterial({ color: 0x95a5a6, metalness: 0.8, roughness: 0.2 });
        const matRed = new THREE.MeshStandardMaterial({ color: 0xe74c3c, metalness: 0.3, roughness: 0.6 });
        const matBlue = new THREE.MeshStandardMaterial({ color: 0x3498db, metalness: 0.3, roughness: 0.6 });
        const matDark = new THREE.MeshStandardMaterial({ color: 0x2c3e50, metalness: 0.5, roughness: 0.7 });

        // --- 3. MECHANICAL ASSEMBLY ---

        // A. The Vertical Rack (Moves Up/Down)
        const rackGroup = new THREE.Group();
        const rackBar = new THREE.Mesh(new THREE.BoxGeometry(0.5, 4, 0.5), matSteel);
        rackGroup.add(rackBar);

        // Add Teeth to Rack
        for(let i=0; i<15; i++) {
            const tooth = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.1, 0.6), matSteel);
            tooth.position.set(0.3, -1.5 + (i * 0.25), 0); // Spaced 0.25 units apart
            rackGroup.add(tooth);
        }
        rackGroup.position.set(-1.5, 2, 0); // Start position
        scene.add(rackGroup);

        // B. The Pinion (Red Gear - Meshes with Rack)
        const pinionGroup = new THREE.Group();
        const pinionCore = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 0.4, 32), matRed);
        pinionCore.rotation.z = Math.PI/2;
        pinionGroup.add(pinionCore);

        // Pinion Teeth
        const numTeethA = 12;
        for(let i=0; i<numTeethA; i++) {
            const angle = (i / numTeethA) * Math.PI * 2;
            const tooth = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.4, 0.15), matRed);
            // Math to place teeth in a circle
            tooth.position.set(Math.cos(angle)*0.8, 0, Math.sin(angle)*0.8);
            tooth.rotation.y = angle;
            pinionGroup.add(tooth);
        }
        pinionGroup.position.set(-0.5, 1, 0); // Place next to rack
        scene.add(pinionGroup);

        // C. The Follower (Blue Gear - Connected to Motor)
        // This simulates a gear reduction or speed increase
        const followerGroup = new THREE.Group();
        const followerCore = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.4, 32), matBlue);
        followerCore.rotation.z = Math.PI/2;
        followerGroup.add(followerCore);

        const numTeethB = 8;
        for(let i=0; i<numTeethB; i++) {
            const angle = (i / numTeethB) * Math.PI * 2;
            const tooth = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.4, 0.12), matBlue);
            tooth.position.set(Math.cos(angle)*0.4, 0, Math.sin(angle)*0.4);
            tooth.rotation.y = angle;
            followerGroup.add(tooth);
        }
        // Place it so teeth interlock with Pinion
        followerGroup.position.set(0.6, 1, 0); 
        scene.add(followerGroup);

        // D. The Electric Motor (Driven by Follower)
        const motorGroup = new THREE.Group();
        const motorBody = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.5, 32), matDark);
        motorBody.rotation.z = Math.PI/2;
        const motorShaft = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.1, 0.1), new THREE.MeshStandardMaterial({color:0xffffff}));
        motorGroup.add(motorBody);
        motorGroup.add(motorShaft); // Visual strip to see rotation
        motorGroup.position.set(2, 1, 0);
        scene.add(motorGroup);

        // Connection Shaft (Pinion to Follower? No, usually Pinion -> Follower. Here let's say they mesh)
        
        // --- 4. PHYSICS STATE ---
        const state = {
            rackY: 2,           // Current Y position
            targetY: 2,         // Where we want to be
            velocity: 0
        };

        // --- 5. INTERACTION ---
        const btn = document.getElementById('pedal-btn');
        btn.addEventListener('mousedown', () => { state.targetY = 0; }); // Push down
        btn.addEventListener('mouseup', () => { state.targetY = 2; });   // Release

        // --- 6. ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            // A. Smooth movement (Linear Interpolation)
            const oldY = state.rackY;
            state.rackY += (state.targetY - state.rackY) * 0.1; // 0.1 = Speed factor
            
            // B. Move the Rack
            rackGroup.position.y = state.rackY;

            // C. Calculate Rotation based on linear movement
            // Delta Y = distance moved this frame
            const deltaY = oldY - state.rackY; 
            
            // Formula: Arc Length = Radius * Angle  ->  Angle = Arc / Radius
            // Pinion Radius is roughly 0.8
            const rotationA = deltaY / 0.8; 

            pinionGroup.rotation.y += rotationA;

            // D. Gear Ratio Logic
            // Gear A (Radius 0.8) drives Gear B (Radius 0.4)
            // Ratio = 0.8 / 0.4 = 2. Gear B spins 2x faster in OPPOSITE direction.
            const rotationB = -(rotationA * 2);
            
            followerGroup.rotation.y += rotationB;
            motorGroup.rotation.x = followerGroup.rotation.y; // Motor spins with Gear B

            // E. Stats
            const speed = Math.abs(deltaY) * 1000;
            document.getElementById('rpm').innerText = Math.floor(speed) + " RPM";
            document.getElementById('energy').innerText = Math.floor(speed * 0.5) + " W";

            controls.update();
            renderer.render(scene, camera);
        }

        // Handle Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>